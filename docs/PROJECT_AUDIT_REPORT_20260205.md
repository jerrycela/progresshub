# ProgressHub å°ˆæ¡ˆå…¨é¢å¯©è¨ˆå ±å‘Š

**æ—¥æœŸ**: 2026-02-05
**ç‰ˆæœ¬**: 1.0
**å¯©è¨ˆç¯„åœ**: è³‡å®‰ã€å¾Œç«¯ APIã€è³‡æ–™åº«ã€å‰å¾Œç«¯æ•´åˆ

---

## åŸ·è¡Œæ‘˜è¦

ç¶“é 20 æ¬¡è¿­ä»£çš„æ·±å…¥åˆ†æï¼Œæœ¬å ±å‘Šæ¶µè“‹ï¼š
1. å‰ç«¯è³‡å®‰æ¼æ´
2. å¾Œç«¯æ¶æ§‹èˆ‡ API å®Œæ•´æ€§
3. è³‡æ–™æ¨¡å‹ä¸€è‡´æ€§
4. å‰å¾Œç«¯æ•´åˆç¼ºå£
5. å¢é‡éƒ¨ç½²å»ºè­°

### é—œéµç™¼ç¾

| åš´é‡åº¦ | é …ç›® | ç‹€æ…‹ |
|--------|------|------|
| ğŸ”´ Critical | Token å„²å­˜åœ¨ localStorage | éœ€ä¿®å¾© |
| ğŸ”´ Critical | ç„¡ CSRF ä¿è­· | éœ€å¯¦ä½œ |
| ğŸ”´ Critical | Gantt API ç«¯é»ç¼ºå¤± | éœ€æ–°å¢ |
| ğŸŸ¡ High | API å›æ‡‰æ ¼å¼ä¸ä¸€è‡´ | éœ€çµ±ä¸€ |
| ğŸŸ¡ High | è³‡æ–™æ¨¡å‹ä¸ä¸€è‡´ | éœ€å°é½Š |
| ğŸŸ¢ Good | å¾Œç«¯æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ | å·²å°±ç·’ |
| ğŸŸ¢ Good | è³‡æ–™åº« Schema å®Œæ•´ | å·²å°±ç·’ |

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šè³‡å®‰å¯©è¨ˆ

### 1.1 Token å„²å­˜ - ğŸ”´ Critical

**ä½ç½®**: `packages/frontend/src/services/api.ts:22-58`

**ç¾ç‹€**:
```typescript
const TOKEN_KEY = 'progresshub_token'
const REFRESH_TOKEN_KEY = 'progresshub_refresh_token'

export const getToken = (): string | null => {
  return localStorage.getItem(TOKEN_KEY)  // âš ï¸ XSS å¯å­˜å–
}
```

**é¢¨éšª**:
- localStorage å¯è¢«ä»»ä½• JavaScript å­˜å–ï¼ˆåŒ…å«æƒ¡æ„æ³¨å…¥è…³æœ¬ï¼‰
- XSS æ”»æ“Šå¯ç«Šå–æ‰€æœ‰ token
- æ•´å€‹å°ˆæ¡ˆæœ‰ 8 è™•ä½¿ç”¨æ­¤ pattern

**å»ºè­°ä¿®å¾©**:
1. æ”¹ç”¨ httpOnly cookies å„²å­˜ refresh token
2. Access token åƒ…å­˜æ–¼è¨˜æ†¶é«”
3. å•Ÿç”¨ SameSite=Strict é˜²æ­¢ CSRF

---

### 1.2 CSRF ä¿è­· - ğŸ”´ Critical

**ç¾ç‹€**: å®Œå…¨æ²’æœ‰ CSRF ä¿è­·æ©Ÿåˆ¶

**å½±éŸ¿çš„æ“ä½œ**:
- POST /tasksï¼ˆå»ºç«‹ä»»å‹™ï¼‰
- PUT /tasks/:idï¼ˆæ›´æ–°ä»»å‹™ï¼‰
- DELETE /tasks/:idï¼ˆåˆªé™¤ä»»å‹™ï¼‰
- æ‰€æœ‰ç‹€æ…‹è®Šæ›´çš„ API

**å»ºè­°ä¿®å¾©**:
1. å¾Œç«¯ç”¢ç”Ÿ CSRF token
2. å‰ç«¯åœ¨æ‰€æœ‰ POST/PUT/DELETE è«‹æ±‚é™„å¸¶ X-CSRF-Token header
3. å¾Œç«¯é©—è­‰ token

---

### 1.3 Console Logging - ğŸŸ¡ High

**ä½ç½®**: `packages/frontend/src/services/api.ts:135,140`

**ç¾ç‹€**:
```typescript
console.warn('[API] æ¬Šé™ä¸è¶³:', error.config?.url)  // âš ï¸ ç”Ÿç”¢ç’°å¢ƒä¹ŸæœƒåŸ·è¡Œ
console.error('[API] ä¼ºæœå™¨éŒ¯èª¤:', error.config?.url)
```

**é¢¨éšª**: ç”Ÿç”¢ç’°å¢ƒæ´©æ¼ç³»çµ±è³‡è¨Š

**ä¿®å¾©**: åŠ ä¸Š DEV ç’°å¢ƒæª¢æŸ¥
```typescript
if (import.meta.env.DEV) {
  console.warn('[API] æ¬Šé™ä¸è¶³:', error.config?.url)
}
```

---

### 1.4 è¼¸å…¥é©—è­‰ - ğŸŸ¡ Medium

**ç¾ç‹€**: ä½¿ç”¨è‡ªè¨‚é©—è­‰é‚è¼¯ï¼Œéæ¥­ç•Œæ¨™æº–

**å•é¡Œ**:
- Email æ­£è¦è¡¨é”å¼éæ–¼ç°¡åŒ–
- ç„¡ URL é©—è­‰
- å¾Œç«¯å¿…é ˆé‡è¤‡é©—è­‰

**å»ºè­°**: æ¡ç”¨ Zod é©—è­‰åº«
```typescript
import { z } from 'zod'

const taskSchema = z.object({
  title: z.string().min(2).max(200),
  email: z.string().email(),
})
```

---

### 1.5 è³‡å®‰æ”¹é€²å„ªå…ˆé †åº

| éšæ®µ | é …ç›® | é ä¼°å·¥æ™‚ |
|------|------|----------|
| Phase 1 | Token æ”¹ç”¨ httpOnly cookie | 4-8 hrs |
| Phase 1 | å¯¦ä½œ CSRF ä¿è­· | 4-6 hrs |
| Phase 1 | ç§»é™¤ç”Ÿç”¢ç’°å¢ƒ console.log | 1 hr |
| Phase 2 | æ”¹ç”¨ Zod é©—è­‰ | 4-6 hrs |
| Phase 2 | åŠ å…¥ Security Headers | 2-4 hrs |

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šå¾Œç«¯æ¶æ§‹åˆ†æ

### 2.1 æŠ€è¡“æ£§

| é …ç›® | æŠ€è¡“ | ç‰ˆæœ¬ |
|------|------|------|
| Framework | Express.js | ^4.18.2 |
| Language | TypeScript | ^5.3.3 |
| Database | PostgreSQL + Prisma | ^5.8.0 |
| Auth | JWT + Slack OAuth | - |
| Logging | Winston | ^3.19.0 |
| Security | Helmet, Rate Limiting | - |
| Testing | Jest + ts-jest | ^30.2.0 |

### 2.2 ç¾æœ‰ API ç«¯é»

**èªè­‰ (`/api/auth`)**
- âœ… `POST /slack` - Slack OAuth ç™»å…¥
- âœ… `GET /me` - å–å¾—ç•¶å‰ä½¿ç”¨è€…
- âœ… `POST /verify` - Token é©—è­‰

**å“¡å·¥ç®¡ç† (`/api/employees`)**
- âœ… CRUD å®Œæ•´å¯¦ä½œ
- âœ… æ¬Šé™ç­‰ç´šç®¡ç†
- âœ… éƒ¨é–€æŒ‡æ´¾

**å°ˆæ¡ˆç®¡ç† (`/api/projects`)**
- âœ… å°ˆæ¡ˆ CRUD
- âœ… ç‹€æ…‹ç®¡ç†
- âœ… é‡Œç¨‹ç¢‘é—œè¯

**ä»»å‹™ç®¡ç† (`/api/tasks`)**
- âœ… å®Œæ•´ CRUD
- âœ… ä»»å‹™æŒ‡æ´¾èˆ‡å”ä½œ
- âœ… é€²åº¦è¿½è¹¤
- âœ… ç‹€æ…‹è½‰æ›
- âœ… `/my` - æˆ‘çš„ä»»å‹™

**é€²åº¦è¿½è¹¤ (`/api/progress`)**
- âœ… é€²åº¦æ—¥èªŒ CRUD
- âœ… æŒ‰å“¡å·¥æŸ¥è©¢æ­·å²

**æ™‚é–“è¿½è¹¤ (`/api/time-*`)**
- âœ… æ™‚é–“æ¢ç›®ç®¡ç†
- âœ… æ ¸å‡†å·¥ä½œæµç¨‹
- âœ… çµ±è¨ˆåˆ†æ

**GitLab æ•´åˆ (`/api/gitlab`)**
- âœ… OAuth æµç¨‹
- âœ… æ´»å‹•è¿½è¹¤
- âœ… Issue åŒæ­¥
- âœ… Webhook è™•ç†

**å¥åº·æª¢æŸ¥ (`/health`)**
- âœ… åŸºæœ¬å­˜æ´»æª¢æŸ¥
- âœ… è³‡æ–™åº«é€£ç·šæª¢æŸ¥
- âœ… è¨˜æ†¶é«”ä½¿ç”¨è³‡è¨Š

### 2.3 å¾Œç«¯è©•ä¼°çµæœ

âœ… **æ ¸å¿ƒåŠŸèƒ½å®Œæ•´** - ç„¡ TODO æˆ–ä½”ä½å¯¦ä½œ
âœ… **è³‡æ–™åº« Schema å®Œæ•´** - 15 å€‹ Model å·²å®šç¾©
âœ… **éŒ¯èª¤è™•ç†å®Œå–„** - Prisma éŒ¯èª¤æ˜ å°„
âœ… **å®‰å…¨ä¸­ä»‹è»Ÿé«”å°±ç·’** - Helmet, Rate Limiting
âœ… **Docker éƒ¨ç½²å°±ç·’** - å¤šéšæ®µå»ºç½®å„ªåŒ–

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šè³‡æ–™æ¨¡å‹åˆ†æ

### 3.1 æ ¸å¿ƒå¯¦é«”

| å¯¦é«” | ç”¨é€” | ç‹€æ…‹ |
|------|------|------|
| Employee | å“¡å·¥å¸³è™Ÿ | âœ… å®Œæ•´ |
| Project | å°ˆæ¡ˆç®¡ç† | âœ… å®Œæ•´ |
| Task | ä»»å‹™è¿½è¹¤ | âœ… å®Œæ•´ |
| Milestone | é‡Œç¨‹ç¢‘ | âœ… å®Œæ•´ |
| ProgressLog | é€²åº¦æ—¥èªŒ | âœ… å®Œæ•´ |
| TimeEntry | æ™‚é–“æ¢ç›® | âœ… å®Œæ•´ |
| TimeCategory | æ™‚é–“åˆ†é¡ | âœ… å®Œæ•´ |
| GitLabConnection | GitLab é€£çµ | âœ… å®Œæ•´ |
| GitLabActivity | GitLab æ´»å‹• | âœ… å®Œæ•´ |

### 3.2 ç‹€æ…‹èˆ‡åˆ—èˆ‰å€¼

**ä»»å‹™ç‹€æ…‹ (Task Status)** - âš ï¸ ä¸ä¸€è‡´
```
å‰ç«¯ shared/types:  UNCLAIMED, CLAIMED, IN_PROGRESS, PAUSED, BLOCKED, DONE (6 ç¨®)
å¾Œç«¯ Prisma:        NOT_STARTED, IN_PROGRESS, COMPLETED, ON_HOLD (4 ç¨®)
Mock è³‡æ–™:          3 ç¨®æ··ç”¨
```

**å»ºè­°**: çµ±ä¸€ä½¿ç”¨ 6 ç¨®ç‹€æ…‹ï¼Œå¾Œç«¯ Schema éœ€æ›´æ–°

**ä½¿ç”¨è€…è§’è‰² (User Role)**
```
EMPLOYEE - ä¸€èˆ¬åŒä»
PM - å°ˆæ¡ˆç¶“ç†
PRODUCER - è£½ä½œäºº
MANAGER - éƒ¨é–€ä¸»ç®¡
```

**éƒ¨é–€ (Department)**
```
ART, PROGRAMMING, PLANNING, QA, SOUND, MANAGEMENT
```

**å°ˆæ¡ˆç‹€æ…‹ (Project Status)**
```
ACTIVE, COMPLETED, ON_HOLD
```

### 3.3 æ¬„ä½å‘½åä¸ä¸€è‡´

| æ¦‚å¿µ | å‰ç«¯æ¬„ä½ | å¾Œç«¯æ¬„ä½ | å»ºè­° |
|------|----------|----------|------|
| ä»»å‹™æ¨™é¡Œ | title | name | çµ±ä¸€ç”¨ title |
| æˆªæ­¢æ—¥æœŸ | dueDate | plannedEndDate | çµ±ä¸€ç”¨ dueDate |
| é€²åº¦ | progress | progressPercentage | çµ±ä¸€ç”¨ progress |

---

## ç¬¬å››éƒ¨åˆ†ï¼šå‰å¾Œç«¯æ•´åˆç¼ºå£

### 4.1 ç¼ºå°‘çš„ API ç«¯é» - ğŸ”´ Critical

| ç«¯é» | ç”¨é€” | å‰ç«¯æœŸæœ› | å¾Œç«¯ç¾ç‹€ |
|------|------|----------|----------|
| `GET /gantt` | ç”˜ç‰¹åœ–å…¨åŸŸè³‡æ–™ | éœ€è¦ | âŒ ä¸å­˜åœ¨ |
| `GET /gantt/stats` | ç”˜ç‰¹åœ–çµ±è¨ˆ | éœ€è¦ | âŒ ä¸å­˜åœ¨ |
| `GET /progress/my` | æˆ‘çš„é€²åº¦æ—¥èªŒ | éœ€è¦ | âŒ ä¸å­˜åœ¨ |

### 4.2 å›æ‡‰æ ¼å¼ä¸ä¸€è‡´ - ğŸŸ¡ High

**å‰ç«¯æœŸæœ›çš„çµ±ä¸€æ ¼å¼**:
```typescript
interface ApiResponse<T> {
  success: boolean
  data?: T
  error?: { code: string; message: string }
  meta?: { total: number; page: number; limit: number }
}
```

**å¾Œç«¯å¯¦éš›å›æ‡‰**:

| ç«¯é» | å‰ç«¯æœŸæœ› | å¾Œç«¯å›æ‡‰ |
|------|----------|----------|
| `/tasks/my` | `{ success, tasks }` | `Task[]` è£¸é™£åˆ— |
| `/employees` | `{ success, employees }` | `{ data, pagination }` |
| `/projects` | `{ success, projects }` | `{ data, pagination }` |

### 4.3 å—å½±éŸ¿çš„é é¢

| é é¢ | ç‹€æ…‹ | å•é¡Œ |
|------|------|------|
| Dashboard | âŒ æœƒå´©æ½° | å›æ‡‰æ ¼å¼éŒ¯èª¤ + ç«¯é»ç¼ºå¤± |
| Gantt | âŒ ç„¡æ³•è¼‰å…¥ | `/gantt` ç«¯é»ä¸å­˜åœ¨ |
| MyTasks | âŒ æœƒå¤±æ•— | å›æ‡‰æ ¼å¼è§£æéŒ¯èª¤ |
| Projects | âš ï¸ éƒ¨åˆ†å¯ç”¨ | å›æ‡‰æ ¼å¼ä¸åŒ¹é… |

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå¢é‡éƒ¨ç½²è¨ˆç•«

æ ¹æ“šã€Œä¸€æ¬¡ä¸€å€‹åŠŸèƒ½ã€åŸå‰‡ï¼Œå»ºè­°ä»¥ä¸‹é †åºï¼š

### Phase 1ï¼šåŸºç¤å»ºè¨­ï¼ˆç¬¬ 1-2 é€±ï¼‰

**Sprint 1.1ï¼šè³‡å®‰ä¿®å¾©**
```
1. Token æ”¹ç”¨ httpOnly cookie
2. å¯¦ä½œ CSRF ä¿è­·
3. ç§»é™¤ç”Ÿç”¢ç’°å¢ƒ console.log
4. é©—è­‰ + éƒ¨ç½² + æ¸¬è©¦
```

**Sprint 1.2ï¼šAPI å›æ‡‰æ ¼å¼çµ±ä¸€**
```
1. å¾Œç«¯çµ±ä¸€å›æ‡‰æ ¼å¼ç‚º { success, data, error, meta }
2. å‰ç«¯ api.ts å°æ‡‰èª¿æ•´
3. é©—è­‰ + éƒ¨ç½² + æ¸¬è©¦
```

### Phase 2ï¼šæ ¸å¿ƒåŠŸèƒ½ä¸²æ¥ï¼ˆç¬¬ 3-4 é€±ï¼‰

**Sprint 2.1ï¼šèªè­‰æµç¨‹**
```
1. å‰ç«¯ Slack OAuth æµç¨‹å°æ¥
2. Token åˆ·æ–°æ©Ÿåˆ¶
3. é©—è­‰ + éƒ¨ç½² + æ¸¬è©¦
```

**Sprint 2.2ï¼šä»»å‹™ç®¡ç† API**
```
1. ä»»å‹™ CRUD å‰å¾Œç«¯ä¸²æ¥
2. ä»»å‹™ç‹€æ…‹è½‰æ›
3. é©—è­‰ + éƒ¨ç½² + æ¸¬è©¦
```

### Phase 3ï¼šé€²éšåŠŸèƒ½ï¼ˆç¬¬ 5-6 é€±ï¼‰

**Sprint 3.1ï¼šç”˜ç‰¹åœ– API**
```
1. æ–°å¢ GET /gantt ç«¯é»
2. æ–°å¢ GET /gantt/stats ç«¯é»
3. å‰ç«¯ä¸²æ¥
4. é©—è­‰ + éƒ¨ç½² + æ¸¬è©¦
```

**Sprint 3.2ï¼šé€²åº¦å›å ±**
```
1. é€²åº¦æ—¥èªŒ API ä¸²æ¥
2. æ–°å¢ GET /progress/my ç«¯é»
3. é©—è­‰ + éƒ¨ç½² + æ¸¬è©¦
```

### Phase 4ï¼šæ•´åˆåŠŸèƒ½ï¼ˆç¬¬ 7-8 é€±ï¼‰

**Sprint 4.1ï¼šå°ˆæ¡ˆèˆ‡é‡Œç¨‹ç¢‘**
```
1. å°ˆæ¡ˆç®¡ç† API ä¸²æ¥
2. é‡Œç¨‹ç¢‘ CRUD
3. é©—è­‰ + éƒ¨ç½² + æ¸¬è©¦
```

**Sprint 4.2ï¼šæ™‚é–“è¿½è¹¤**
```
1. æ™‚é–“æ¢ç›® API ä¸²æ¥
2. æ ¸å‡†å·¥ä½œæµç¨‹
3. é©—è­‰ + éƒ¨ç½² + æ¸¬è©¦
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šåŸ·è¡Œæ¸…å–®

### ç«‹å³åŸ·è¡Œï¼ˆæœ¬é€±ï¼‰

- [ ] ä¿®å¾© localStorage token å®‰å…¨æ¼æ´
- [ ] ç§»é™¤ç”Ÿç”¢ç’°å¢ƒ console.log
- [ ] çµ±ä¸€ä»»å‹™ç‹€æ…‹åˆ—èˆ‰å€¼

### çŸ­æœŸåŸ·è¡Œï¼ˆ2 é€±å…§ï¼‰

- [ ] å¯¦ä½œ CSRF ä¿è­·æ©Ÿåˆ¶
- [ ] çµ±ä¸€ API å›æ‡‰æ ¼å¼
- [ ] æ–°å¢ç¼ºå¤±çš„ Gantt API ç«¯é»

### ä¸­æœŸåŸ·è¡Œï¼ˆ1 å€‹æœˆå…§ï¼‰

- [ ] å®Œæˆèªè­‰æµç¨‹å‰å¾Œç«¯ä¸²æ¥
- [ ] å®Œæˆä»»å‹™ç®¡ç†æ ¸å¿ƒåŠŸèƒ½ä¸²æ¥
- [ ] éƒ¨ç½²æ¸¬è©¦ç’°å¢ƒé©—è­‰

---

## é™„éŒ„ Aï¼šæª”æ¡ˆè·¯å¾‘åƒè€ƒ

**å‰ç«¯è³‡å®‰ç›¸é—œ**:
- `packages/frontend/src/services/api.ts` - Token ç®¡ç†ã€API æ””æˆªå™¨
- `packages/frontend/src/stores/auth.ts` - èªè­‰ç‹€æ…‹
- `packages/frontend/src/router/index.ts` - è·¯ç”±å®ˆè¡›
- `packages/frontend/src/composables/useFormValidation.ts` - è¼¸å…¥é©—è­‰
- `packages/frontend/src/composables/useErrorHandler.ts` - éŒ¯èª¤è™•ç†

**å¾Œç«¯æ ¸å¿ƒ**:
- `backend/src/middleware/auth.ts` - èªè­‰ä¸­ä»‹è»Ÿé«”
- `backend/src/config/env.ts` - ç’°å¢ƒè®Šæ•¸
- `backend/prisma/schema.prisma` - è³‡æ–™åº« Schema
- `backend/src/routes/` - API è·¯ç”±ï¼ˆ17 å€‹æª”æ¡ˆï¼‰
- `backend/src/services/` - æœå‹™å±¤ï¼ˆ13 å€‹é¡åˆ¥ï¼‰

**å…±ç”¨é¡å‹**:
- `packages/shared/types/index.ts` - å…±ç”¨ TypeScript é¡å‹

---

## é™„éŒ„ Bï¼šéƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®

```bash
# 1. å»ºç½®å‰ç«¯
cd packages/frontend && npm run build

# 2. æª¢æŸ¥ TypeScript éŒ¯èª¤
npx vue-tsc --noEmit

# 3. å»ºç½®å¾Œç«¯
cd backend && npm run build

# 4. åŸ·è¡Œæ¸¬è©¦
npm test

# 5. æª¢æŸ¥å®‰å…¨æ¼æ´
npm audit

# 6. é©—è­‰ç’°å¢ƒè®Šæ•¸
# ç¢ºèªæ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸å·²è¨­å®š
```

---

## çµè«–

ProgressHub å°ˆæ¡ˆçš„**å¾Œç«¯æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å¯¦ä½œ**ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—œéµå•é¡Œéœ€è¦è§£æ±ºï¼š

1. **è³‡å®‰æ¼æ´**ï¼šToken å„²å­˜æ–¹å¼ä¸å®‰å…¨ï¼Œéœ€ç«‹å³ä¿®å¾©
2. **å‰å¾Œç«¯æ•´åˆ**ï¼šAPI æ ¼å¼ä¸ä¸€è‡´ï¼Œç¼ºå°‘éƒ¨åˆ†ç«¯é»
3. **è³‡æ–™æ¨¡å‹**ï¼šç‹€æ…‹åˆ—èˆ‰å€¼éœ€è¦çµ±ä¸€

å»ºè­°æ¡ç”¨**å¢é‡å¼éƒ¨ç½²ç­–ç•¥**ï¼Œæ¯æ¬¡åªæ¨é€ä¸€å€‹åŠŸèƒ½æ¨¡çµ„ï¼Œç¢ºä¿ï¼š
- æ¯æ¬¡è®Šæ›´ç¯„åœå°ï¼Œæ˜“æ–¼é™¤éŒ¯
- éƒ¨ç½²å•é¡Œå¯å¿«é€Ÿå®šä½
- é€æ­¥å»ºç«‹ç©©å®šçš„ç”Ÿç”¢ç’°å¢ƒ

---

*å ±å‘Šç”¢ç”Ÿæ—¥æœŸ: 2026-02-05*
*å¯©è¨ˆåŸ·è¡Œ: Claude Code*
