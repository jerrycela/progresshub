// Prisma Schema for ProgressHub
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 員工表
model Employee {
  id                String   @id @default(uuid())
  name              String
  email             String   @unique
  slackUserId       String?  @unique @map("slack_user_id")
  department        String?
  permissionLevel   PermissionLevel @default(EMPLOYEE) @map("permission_level")
  managedProjects   String[] @map("managed_projects")
  hourlyRate        Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  avatarUrl         String?  @map("avatar_url")
  functionType      String?  @map("function_type")
  isActive          Boolean  @default(true) @map("is_active")
  lastActiveAt      DateTime? @map("last_active_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  assignedTasks     Task[]        @relation("AssignedTasks")
  createdTasks      Task[]        @relation("CreatedTasks")
  progressLogs      ProgressLog[]
  timeEntries       TimeEntry[]   @relation("EmployeeTimeEntries")
  timeEstimates     TimeEstimate[] @relation("TimeEstimates")
  gitlabConnections GitLabConnection[]
  taskNotes         TaskNote[]
  userSettings      UserSettings?
  createdMilestones Milestone[]   @relation("MilestoneCreator")

  @@map("employees")
}

// 專案表
model Project {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  status      ProjectStatus @default(ACTIVE)
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tasks       Task[]
  milestones  Milestone[]
  timeEntries TimeEntry[]

  @@map("projects")
}

// 任務表
model Task {
  id                  String   @id @default(uuid())
  projectId           String   @map("project_id")
  name                String
  description         String?  @db.Text
  assignedToId        String?  @map("assigned_to")
  creatorId           String?  @map("creator_id")
  collaborators       String[]
  plannedStartDate    DateTime? @map("planned_start_date")
  plannedEndDate      DateTime? @map("planned_end_date")
  actualStartDate     DateTime? @map("actual_start_date")
  actualEndDate       DateTime? @map("actual_end_date")
  progressPercentage  Int      @default(0) @map("progress_percentage")
  status              TaskStatus @default(UNCLAIMED)
  priority            String?  @default("MEDIUM")
  functionTags        String[] @map("function_tags")
  estimatedHours      Decimal? @map("estimated_hours") @db.Decimal(6, 2)
  actualHours         Decimal? @map("actual_hours") @db.Decimal(6, 2)
  blockerReason       String?  @map("blocker_reason")
  pauseReason         String?  @map("pause_reason")
  pauseNote           String?  @map("pause_note") @db.Text
  pausedAt            DateTime? @map("paused_at")
  closedAt            DateTime? @map("closed_at")
  dependencies        String[]
  milestoneId         String?  @map("milestone_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  project             Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo          Employee? @relation("AssignedTasks", fields: [assignedToId], references: [id])
  creator             Employee? @relation("CreatedTasks", fields: [creatorId], references: [id])
  milestone           Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  progressLogs        ProgressLog[]
  taskNotes           TaskNote[]
  timeEntries         TimeEntry[]
  timeEstimate        TimeEstimate?
  gitlabActivities    GitLabActivity[]
  gitlabIssueMapping  GitLabIssueMapping?

  @@index([projectId])
  @@index([assignedToId])
  @@index([creatorId])
  @@index([milestoneId])
  @@index([status])
  @@map("tasks")
}

// 里程碑表
model Milestone {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  targetDate  DateTime @map("target_date")
  status      MilestoneStatus @default(PENDING)
  description String?  @db.Text
  color       String?  @default("#3B82F6")
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy   Employee? @relation("MilestoneCreator", fields: [createdById], references: [id])
  tasks       Task[]

  @@index([projectId])
  @@map("milestones")
}

// 進度記錄表
model ProgressLog {
  id                  String   @id @default(uuid())
  taskId              String   @map("task_id")
  employeeId          String   @map("employee_id")
  progressPercentage  Int      @map("progress_percentage")
  reportType          String   @default("PROGRESS") @map("report_type")
  progressDelta       Int?     @map("progress_delta")
  notes               String?  @db.Text
  blockerReason       String?  @map("blocker_reason")
  reportedAt          DateTime @default(now()) @map("reported_at")

  // Relations
  task                Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  employee            Employee @relation(fields: [employeeId], references: [id])

  @@index([taskId])
  @@index([employeeId])
  @@index([reportedAt])
  @@map("progress_logs")
}

// 任務註記表
model TaskNote {
  id          String   @id @default(uuid())
  taskId      String   @map("task_id")
  content     String   @db.Text
  authorId    String?  @map("author_id")
  authorName  String   @map("author_name")
  authorRole  String   @map("author_role")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author      Employee? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@map("task_notes")
}

// 使用者設定表
model UserSettings {
  id         String @id @default(uuid())
  employeeId String @unique @map("employee_id")
  settings   Json   @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// ============================================
// 工時追蹤功能 (Time Tracking Feature)
// ============================================

// 工時類別表
model TimeCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String   @default("#3B82F6")
  billable  Boolean  @default(true)
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  timeEntries TimeEntry[]

  @@map("time_categories")
}

// 工時記錄表
model TimeEntry {
  id          String          @id @default(uuid())
  employeeId  String          @map("employee_id")
  projectId   String          @map("project_id")
  taskId      String?         @map("task_id")
  categoryId  String          @map("category_id")
  date        DateTime        @db.Date
  hours       Decimal         @db.Decimal(4, 2)
  description String?         @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  employee       Employee        @relation("EmployeeTimeEntries", fields: [employeeId], references: [id])
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task           Task?           @relation(fields: [taskId], references: [id], onDelete: SetNull)
  category       TimeCategory    @relation(fields: [categoryId], references: [id])
  gitlabActivity GitLabActivity?

  @@index([employeeId])
  @@index([projectId])
  @@index([taskId])
  @@index([categoryId])
  @@index([date])
  @@map("time_entries")
}

// 工時預估表
model TimeEstimate {
  id             String   @id @default(uuid())
  taskId         String   @unique @map("task_id")
  estimatedHours Decimal  @map("estimated_hours") @db.Decimal(6, 2)
  estimatedBy    String   @map("estimated_by")
  notes          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  task           Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  estimator      Employee @relation("TimeEstimates", fields: [estimatedBy], references: [id])

  @@map("time_estimates")
}

// Enums

enum PermissionLevel {
  EMPLOYEE
  PM
  PRODUCER
  MANAGER
  ADMIN
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  PAUSED
}

enum TaskStatus {
  UNCLAIMED
  CLAIMED
  IN_PROGRESS
  PAUSED
  DONE
  BLOCKED
}

enum MilestoneStatus {
  PENDING
  ACHIEVED
}

// ============================================
// GitLab 整合功能 (GitLab Integration)
// ============================================

enum GitLabActivityType {
  COMMIT
  MR_OPENED
  MR_MERGED
  MR_CLOSED
  MR_COMMENT
  MR_APPROVED
  ISSUE_CREATED
  ISSUE_CLOSED
  ISSUE_UPDATED
}

enum SyncDirection {
  GITLAB_TO_TASK
  TASK_TO_GITLAB
  BIDIRECTIONAL
}

// GitLab 實例配置表
model GitLabInstance {
  id              String   @id @default(uuid())
  name            String
  baseUrl         String   @map("base_url")
  clientId        String   @map("client_id")
  clientSecret    String   @map("client_secret")
  webhookSecret   String?  @map("webhook_secret")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  connections     GitLabConnection[]

  @@unique([baseUrl])
  @@map("gitlab_instances")
}

// GitLab 帳號連結表
model GitLabConnection {
  id              String    @id @default(uuid())
  employeeId      String    @map("employee_id")
  instanceId      String    @map("instance_id")
  gitlabUserId    Int       @map("gitlab_user_id")
  gitlabUsername  String    @map("gitlab_username")
  accessToken     String    @map("access_token")
  refreshToken    String?   @map("refresh_token")
  tokenExpiresAt  DateTime? @map("token_expires_at")
  autoConvertTime Boolean   @default(false) @map("auto_convert_time")
  syncCommits     Boolean   @default(true) @map("sync_commits")
  syncMRs         Boolean   @default(true) @map("sync_mrs")
  syncIssues      Boolean   @default(true) @map("sync_issues")
  connectedAt     DateTime  @default(now()) @map("connected_at")
  lastSyncAt      DateTime? @map("last_sync_at")
  isActive        Boolean   @default(true) @map("is_active")

  // Relations
  employee        Employee         @relation(fields: [employeeId], references: [id])
  instance        GitLabInstance   @relation(fields: [instanceId], references: [id])
  activities      GitLabActivity[]
  issueMappings   GitLabIssueMapping[]

  @@unique([employeeId, instanceId])
  @@index([employeeId])
  @@index([instanceId])
  @@map("gitlab_connections")
}

// GitLab 活動記錄表
model GitLabActivity {
  id              String             @id @default(uuid())
  connectionId    String             @map("connection_id")
  activityType    GitLabActivityType @map("activity_type")
  gitlabEventId   String             @unique @map("gitlab_event_id")
  projectPath     String             @map("project_path")

  commitSha       String?            @map("commit_sha")
  commitMessage   String?            @map("commit_message") @db.Text
  additions       Int?               @default(0)
  deletions       Int?               @default(0)

  mrIid           Int?               @map("mr_iid")
  mrTitle         String?            @map("mr_title")
  mrState         String?            @map("mr_state")

  issueIid        Int?               @map("issue_iid")
  issueTitle      String?            @map("issue_title")

  activityAt      DateTime           @map("activity_at")

  taskId          String?            @map("task_id")
  timeEntryId     String?            @unique @map("time_entry_id")
  suggestedHours  Decimal?           @db.Decimal(4, 2) @map("suggested_hours")

  createdAt       DateTime           @default(now()) @map("created_at")

  // Relations
  connection      GitLabConnection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  task            Task?              @relation(fields: [taskId], references: [id], onDelete: SetNull)
  timeEntry       TimeEntry?         @relation(fields: [timeEntryId], references: [id], onDelete: SetNull)

  @@index([connectionId, activityAt])
  @@index([taskId])
  @@index([projectPath])
  @@map("gitlab_activities")
}

// GitLab Issue 對應表
model GitLabIssueMapping {
  id              String        @id @default(uuid())
  connectionId    String        @map("connection_id")
  gitlabIssueId   Int           @map("gitlab_issue_id")
  gitlabIssueIid  Int           @map("gitlab_issue_iid")
  projectPath     String        @map("project_path")
  issueUrl        String        @map("issue_url")
  taskId          String        @unique @map("task_id")
  syncDirection   SyncDirection @default(BIDIRECTIONAL) @map("sync_direction")
  lastSyncAt      DateTime?     @map("last_sync_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  connection      GitLabConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  task            Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([connectionId, gitlabIssueId])
  @@index([taskId])
  @@map("gitlab_issue_mappings")
}
