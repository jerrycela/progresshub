// Prisma Schema for ProgressHub
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 員工表
model Employee {
  id                String   @id @default(uuid())
  name              String
  email             String   @unique
  slackUserId       String   @unique @map("slack_user_id")
  department        String?
  permissionLevel   PermissionLevel @default(EMPLOYEE) @map("permission_level")
  managedProjects   String[] @map("managed_projects") // JSON Array of project IDs for PM
  hourlyRate        Decimal? @map("hourly_rate") @db.Decimal(10, 2) // 時薪（用於成本計算）
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  assignedTasks     Task[]        @relation("AssignedTasks")
  progressLogs      ProgressLog[]
  timeEntries       TimeEntry[]   @relation("EmployeeTimeEntries")
  approvedEntries   TimeEntry[]   @relation("ApprovedTimeEntries")
  timeEstimates     TimeEstimate[] @relation("TimeEstimates")

  @@map("employees")
}

// 專案表
model Project {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tasks       Task[]
  milestones  Milestone[]
  timeEntries TimeEntry[]

  @@map("projects")
}

// 任務表
model Task {
  id                  String   @id @default(uuid())
  projectId           String   @map("project_id")
  name                String
  assignedToId        String   @map("assigned_to")
  collaborators       String[] // JSON Array of employee IDs
  plannedStartDate    DateTime @map("planned_start_date")
  plannedEndDate      DateTime @map("planned_end_date")
  actualStartDate     DateTime? @map("actual_start_date")
  actualEndDate       DateTime? @map("actual_end_date")
  progressPercentage  Int      @default(0) @map("progress_percentage")
  status              TaskStatus @default(NOT_STARTED)
  dependencies        String[] // JSON Array of task IDs
  milestoneId         String?  @map("milestone_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  project             Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo          Employee @relation("AssignedTasks", fields: [assignedToId], references: [id])
  milestone           Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  progressLogs        ProgressLog[]
  timeEntries         TimeEntry[]
  timeEstimate        TimeEstimate?

  @@index([projectId])
  @@index([assignedToId])
  @@index([milestoneId])
  @@map("tasks")
}

// 里程碑表
model Milestone {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  targetDate  DateTime @map("target_date")
  status      MilestoneStatus @default(PENDING)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([projectId])
  @@map("milestones")
}

// 進度記錄表
model ProgressLog {
  id                  String   @id @default(uuid())
  taskId              String   @map("task_id")
  employeeId          String   @map("employee_id")
  progressPercentage  Int      @map("progress_percentage")
  notes               String?  @db.Text
  reportedAt          DateTime @default(now()) @map("reported_at")

  // Relations
  task                Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  employee            Employee @relation(fields: [employeeId], references: [id])

  @@index([taskId])
  @@index([employeeId])
  @@index([reportedAt])
  @@map("progress_logs")
}

// ============================================
// 工時追蹤功能 (Time Tracking Feature)
// ============================================

// 工時類別表
model TimeCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String   @default("#3B82F6")
  billable  Boolean  @default(true)
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  timeEntries TimeEntry[]

  @@map("time_categories")
}

// 工時記錄表
model TimeEntry {
  id          String          @id @default(uuid())
  employeeId  String          @map("employee_id")
  projectId   String          @map("project_id")
  taskId      String?         @map("task_id")
  categoryId  String          @map("category_id")
  date        DateTime        @db.Date
  hours       Decimal         @db.Decimal(4, 2)
  description String?         @db.Text
  status      TimeEntryStatus @default(PENDING)
  approvedBy  String?         @map("approved_by")
  approvedAt  DateTime?       @map("approved_at")
  rejectedReason String?      @map("rejected_reason") @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  employee    Employee      @relation("EmployeeTimeEntries", fields: [employeeId], references: [id])
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?         @relation(fields: [taskId], references: [id], onDelete: SetNull)
  category    TimeCategory  @relation(fields: [categoryId], references: [id])
  approver    Employee?     @relation("ApprovedTimeEntries", fields: [approvedBy], references: [id])

  @@index([employeeId])
  @@index([projectId])
  @@index([taskId])
  @@index([categoryId])
  @@index([date])
  @@index([status])
  @@map("time_entries")
}

// 工時預估表
model TimeEstimate {
  id             String   @id @default(uuid())
  taskId         String   @unique @map("task_id")
  estimatedHours Decimal  @map("estimated_hours") @db.Decimal(6, 2)
  estimatedBy    String   @map("estimated_by")
  notes          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  task           Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  estimator      Employee @relation("TimeEstimates", fields: [estimatedBy], references: [id])

  @@map("time_estimates")
}

// 工時記錄狀態
enum TimeEntryStatus {
  PENDING   // 待審核
  APPROVED  // 已核准
  REJECTED  // 已駁回
}

// Enums
enum PermissionLevel {
  EMPLOYEE
  PM
  ADMIN
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  PAUSED
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum MilestoneStatus {
  PENDING
  ACHIEVED
}
