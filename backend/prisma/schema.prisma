// Prisma Schema for ProgressHub
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 員工表
model Employee {
  id                String   @id @default(uuid())
  name              String
  email             String   @unique
  slackUserId       String   @unique @map("slack_user_id")
  department        String?
  permissionLevel   PermissionLevel @default(EMPLOYEE) @map("permission_level")
  managedProjects   String[] @map("managed_projects") // JSON Array of project IDs for PM
  hourlyRate        Decimal? @map("hourly_rate") @db.Decimal(10, 2) // 時薪（用於成本計算）
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  assignedTasks     Task[]        @relation("AssignedTasks")
  progressLogs      ProgressLog[]
  timeEntries       TimeEntry[]   @relation("EmployeeTimeEntries")
  approvedEntries   TimeEntry[]   @relation("ApprovedTimeEntries")
  timeEstimates     TimeEstimate[] @relation("TimeEstimates")
  gitlabConnections GitLabConnection[]

  @@map("employees")
}

// 專案表
model Project {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tasks       Task[]
  milestones  Milestone[]
  timeEntries TimeEntry[]

  @@map("projects")
}

// 任務表
model Task {
  id                  String   @id @default(uuid())
  projectId           String   @map("project_id")
  name                String
  assignedToId        String   @map("assigned_to")
  collaborators       String[] // JSON Array of employee IDs
  plannedStartDate    DateTime @map("planned_start_date")
  plannedEndDate      DateTime @map("planned_end_date")
  actualStartDate     DateTime? @map("actual_start_date")
  actualEndDate       DateTime? @map("actual_end_date")
  progressPercentage  Int      @default(0) @map("progress_percentage")
  status              TaskStatus @default(NOT_STARTED)
  dependencies        String[] // JSON Array of task IDs
  milestoneId         String?  @map("milestone_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  project             Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo          Employee @relation("AssignedTasks", fields: [assignedToId], references: [id])
  milestone           Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  progressLogs        ProgressLog[]
  timeEntries         TimeEntry[]
  timeEstimate        TimeEstimate?
  gitlabActivities    GitLabActivity[]
  gitlabIssueMapping  GitLabIssueMapping?

  @@index([projectId])
  @@index([assignedToId])
  @@index([milestoneId])
  @@map("tasks")
}

// 里程碑表
model Milestone {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  targetDate  DateTime @map("target_date")
  status      MilestoneStatus @default(PENDING)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([projectId])
  @@map("milestones")
}

// 進度記錄表
model ProgressLog {
  id                  String   @id @default(uuid())
  taskId              String   @map("task_id")
  employeeId          String   @map("employee_id")
  progressPercentage  Int      @map("progress_percentage")
  notes               String?  @db.Text
  reportedAt          DateTime @default(now()) @map("reported_at")

  // Relations
  task                Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  employee            Employee @relation(fields: [employeeId], references: [id])

  @@index([taskId])
  @@index([employeeId])
  @@index([reportedAt])
  @@map("progress_logs")
}

// ============================================
// 工時追蹤功能 (Time Tracking Feature)
// ============================================

// 工時類別表
model TimeCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String   @default("#3B82F6")
  billable  Boolean  @default(true)
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  timeEntries TimeEntry[]

  @@map("time_categories")
}

// 工時記錄表
model TimeEntry {
  id          String          @id @default(uuid())
  employeeId  String          @map("employee_id")
  projectId   String          @map("project_id")
  taskId      String?         @map("task_id")
  categoryId  String          @map("category_id")
  date        DateTime        @db.Date
  hours       Decimal         @db.Decimal(4, 2)
  description String?         @db.Text
  status      TimeEntryStatus @default(PENDING)
  approvedBy  String?         @map("approved_by")
  approvedAt  DateTime?       @map("approved_at")
  rejectedReason String?      @map("rejected_reason") @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  employee       Employee        @relation("EmployeeTimeEntries", fields: [employeeId], references: [id])
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task           Task?           @relation(fields: [taskId], references: [id], onDelete: SetNull)
  category       TimeCategory    @relation(fields: [categoryId], references: [id])
  approver       Employee?       @relation("ApprovedTimeEntries", fields: [approvedBy], references: [id])
  gitlabActivity GitLabActivity?

  @@index([employeeId])
  @@index([projectId])
  @@index([taskId])
  @@index([categoryId])
  @@index([date])
  @@index([status])
  @@map("time_entries")
}

// 工時預估表
model TimeEstimate {
  id             String   @id @default(uuid())
  taskId         String   @unique @map("task_id")
  estimatedHours Decimal  @map("estimated_hours") @db.Decimal(6, 2)
  estimatedBy    String   @map("estimated_by")
  notes          String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  task           Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  estimator      Employee @relation("TimeEstimates", fields: [estimatedBy], references: [id])

  @@map("time_estimates")
}

// 工時記錄狀態
enum TimeEntryStatus {
  PENDING   // 待審核
  APPROVED  // 已核准
  REJECTED  // 已駁回
}

// Enums
enum PermissionLevel {
  EMPLOYEE
  PM
  ADMIN
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  PAUSED
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum MilestoneStatus {
  PENDING
  ACHIEVED
}

// ============================================
// GitLab 整合功能 (GitLab Integration)
// ============================================

// GitLab 活動類型
enum GitLabActivityType {
  COMMIT          // Git 提交
  MR_OPENED       // MR 開啟
  MR_MERGED       // MR 合併
  MR_CLOSED       // MR 關閉
  MR_COMMENT      // MR 評論
  MR_APPROVED     // MR 核准
  ISSUE_CREATED   // Issue 建立
  ISSUE_CLOSED    // Issue 關閉
  ISSUE_UPDATED   // Issue 更新
}

// 同步方向
enum SyncDirection {
  GITLAB_TO_TASK   // GitLab -> ProgressHub
  TASK_TO_GITLAB   // ProgressHub -> GitLab
  BIDIRECTIONAL    // 雙向同步
}

// GitLab 實例配置表
model GitLabInstance {
  id              String   @id @default(uuid())
  name            String                              // 顯示名稱，如 "公司 GitLab"
  baseUrl         String   @map("base_url")           // 實例 URL，如 "https://gitlab.company.com"
  clientId        String   @map("client_id")          // OAuth Application ID
  clientSecret    String   @map("client_secret")      // OAuth Secret（需加密儲存）
  webhookSecret   String?  @map("webhook_secret")     // Webhook 驗證密鑰
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  connections     GitLabConnection[]

  @@unique([baseUrl])
  @@map("gitlab_instances")
}

// GitLab 帳號連結表
model GitLabConnection {
  id              String    @id @default(uuid())
  employeeId      String    @map("employee_id")
  instanceId      String    @map("instance_id")
  gitlabUserId    Int       @map("gitlab_user_id")       // GitLab 使用者 ID
  gitlabUsername  String    @map("gitlab_username")      // GitLab 使用者名稱
  accessToken     String    @map("access_token")         // OAuth Access Token（需加密）
  refreshToken    String?   @map("refresh_token")        // OAuth Refresh Token（需加密）
  tokenExpiresAt  DateTime? @map("token_expires_at")     // Token 過期時間
  autoConvertTime Boolean   @default(false) @map("auto_convert_time") // 自動轉換工時
  syncCommits     Boolean   @default(true) @map("sync_commits")       // 同步 Commits
  syncMRs         Boolean   @default(true) @map("sync_mrs")           // 同步 MRs
  syncIssues      Boolean   @default(true) @map("sync_issues")        // 同步 Issues
  connectedAt     DateTime  @default(now()) @map("connected_at")
  lastSyncAt      DateTime? @map("last_sync_at")
  isActive        Boolean   @default(true) @map("is_active")

  // Relations
  employee        Employee         @relation(fields: [employeeId], references: [id])
  instance        GitLabInstance   @relation(fields: [instanceId], references: [id])
  activities      GitLabActivity[]
  issueMappings   GitLabIssueMapping[]

  @@unique([employeeId, instanceId])  // 每個員工每個實例只能有一個連結
  @@index([employeeId])
  @@index([instanceId])
  @@map("gitlab_connections")
}

// GitLab 活動記錄表
model GitLabActivity {
  id              String             @id @default(uuid())
  connectionId    String             @map("connection_id")
  activityType    GitLabActivityType @map("activity_type")
  gitlabEventId   String             @unique @map("gitlab_event_id") // GitLab 事件唯一 ID
  projectPath     String             @map("project_path")            // 專案路徑 "group/project"

  // Commit 相關欄位
  commitSha       String?            @map("commit_sha")
  commitMessage   String?            @map("commit_message") @db.Text
  additions       Int?               @default(0)                      // 新增行數
  deletions       Int?               @default(0)                      // 刪除行數

  // MR 相關欄位
  mrIid           Int?               @map("mr_iid")                   // MR 編號
  mrTitle         String?            @map("mr_title")
  mrState         String?            @map("mr_state")                 // opened/merged/closed

  // Issue 相關欄位
  issueIid        Int?               @map("issue_iid")
  issueTitle      String?            @map("issue_title")

  activityAt      DateTime           @map("activity_at")              // 活動發生時間

  // 關聯到 ProgressHub
  taskId          String?            @map("task_id")                  // 關聯的任務
  timeEntryId     String?            @unique @map("time_entry_id")    // 轉換後的工時記錄
  suggestedHours  Decimal?           @db.Decimal(4, 2) @map("suggested_hours") // 建議工時

  createdAt       DateTime           @default(now()) @map("created_at")

  // Relations
  connection      GitLabConnection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  task            Task?              @relation(fields: [taskId], references: [id], onDelete: SetNull)
  timeEntry       TimeEntry?         @relation(fields: [timeEntryId], references: [id], onDelete: SetNull)

  @@index([connectionId, activityAt])
  @@index([taskId])
  @@index([projectPath])
  @@map("gitlab_activities")
}

// GitLab Issue 對應表
model GitLabIssueMapping {
  id              String        @id @default(uuid())
  connectionId    String        @map("connection_id")
  gitlabIssueId   Int           @map("gitlab_issue_id")      // GitLab Issue ID
  gitlabIssueIid  Int           @map("gitlab_issue_iid")     // GitLab Issue 編號
  projectPath     String        @map("project_path")
  issueUrl        String        @map("issue_url")            // Issue 完整 URL
  taskId          String        @unique @map("task_id")      // 對應的任務 ID
  syncDirection   SyncDirection @default(BIDIRECTIONAL) @map("sync_direction")
  lastSyncAt      DateTime?     @map("last_sync_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  connection      GitLabConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  task            Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([connectionId, gitlabIssueId])
  @@index([taskId])
  @@map("gitlab_issue_mappings")
}
